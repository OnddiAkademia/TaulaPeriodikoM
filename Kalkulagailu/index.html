<!doctype html>
<html lang="eu">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Masa Molar eta Ekuazio Doiketa</title>
<style>
:root{
  --bg:#f1f8f4;
  --panel:#fff;
  --accent:#7a9c89;
  --text:#2c3e50;
  --muted:#7f8c8d;
  --gap:12px;
  --radius:15px;
  --transition:all .25s ease;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
  display:flex;
  align-items:flex-start;
  justify-content:center;
  padding:20px;
  padding-top:40px;
}
.container{
  width:100%;
  max-width:1000px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:30px;
  align-items:start;
  position:relative;
  top:0;
}
.panel{
  background:var(--panel);
  border-radius:var(--radius);
  padding:30px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}
h1{
  text-align:center;
  margin-bottom:15px;
  font-size:2em;
  letter-spacing:.5px;
  grid-column:1/-1;
  margin-top:0;
}
.aviso{
  text-align:center;
  margin-bottom:30px;
  font-size:14px;
  color:#e74c3c;
  background:#ffeaa7;
  padding:10px 15px;
  border-radius:var(--radius);
  border:1px solid #fdcb6e;
  grid-column:1/-1;
}
h2{
  text-align:center;
  margin-bottom:20px;
  font-size:1.4em;
  color:var(--accent);
}
label{
  display:block;
  margin-bottom:6px;
  font-size:14px;
  opacity:.9;
}
input[type=text]{
  width:100%;
  padding:12px 16px;
  background:#fafbfc;
  border:1px solid #e0e6e1;
  border-radius:var(--radius);
  color:var(--text);
  font-size:15px;
  outline:none;
  transition:var(--transition);
}
input[type=text]:focus{
  border-color:var(--accent);
  box-shadow:0 0 12px rgba(122,156,137,.25);
  transform:translateY(-1px);
}
.result{
  margin-top:var(--gap);
  padding:16px;
  background:#e8f1ed;
  border:1px solid #d0e0d7;
  border-radius:var(--radius);
  font-size:1.1em;
  text-align:center;
  min-height:48px;
  display:flex;
  align-items:center;
  justify-content:center;
  line-height:1.4;
}
.error{
  background:#ffeaa7;
  border-color:#fdcb6e;
  color:#2d3436;
}
.datos-elementos{
  margin-top:var(--gap);
  padding:15px;
  background:#f8faf9;
  border:1px solid #e0e6e1;
  border-radius:var(--radius);
  font-size:13px;
}
.datos-elementos h3{
  margin-bottom:10px;
  font-size:14px;
  color:var(--accent);
  text-align:center;
}
.elementos-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(100px, 1fr));
  gap:8px;
  font-size:12px;
}
.elemento-item{
  display:flex;
  justify-content:space-between;
  padding:6px 8px;
  background:white;
  border-radius:6px;
  border:1px solid #e8ece9;
}
.details{
  margin-top:var(--gap);
  font-size:12px;
  opacity:.8;
  line-height:1.4;
}
.details ul{
  list-style:none;
  padding-left:0;
}
.details li{
  margin:4px 0;
}
.btn-oreka{
  margin-top:10px;
  width:100%;
  padding:12px;
  background:var(--accent);
  color:#fff;
  border:none;
  border-radius:var(--radius);
  font-size:15px;
  cursor:pointer;
  transition:var(--transition);
}
.btn-oreka:hover{
  background:#6a8b79;
  transform:translateY(-1px);
}
.coeficiente {
  color: #e74c3c;
  font-weight: bold;
}
.subindice {
  vertical-align: sub;
  font-size: 0.75em;
  position: relative;
  bottom: -0.25em;
}

/* Responsive */
@media (max-width: 768px) {
  body{
    padding:15px;
    padding-top:30px;
  }
  .container{
    grid-template-columns:1fr;
    max-width:500px;
    gap:20px;
  }
  .panel{
    padding:25px;
  }
  .elementos-grid{
    grid-template-columns:repeat(auto-fit, minmax(80px, 1fr));
  }
  h1{
    font-size:1.7em;
    margin-bottom:15px;
  }
  .aviso{
    font-size:13px;
    padding:8px 12px;
    margin-bottom:20px;
  }
}
</style>
</head>
<body>
<div class="container">
  <h1>Masa Molar eta Ekuazio Doiketa</h1>
  
  <div class="aviso">
    Adi! Elementuen letra larriak eta xeheak errespetatu tresnen funtzionamendu zuzena ziurtatzeko
  </div>

  <!-- === MASA MOLAR === -->
  <div class="panel">
    <h2>Masa Molar Kalkulagailua</h2>
    <label for="formula">Konposatu Kimikoa</label>
    <input id="formula" type="text" placeholder="Adib: H2SO4, Ca(OH)2, K3[Fe(CN)6]"/>
    <div id="result" class="result">Masa molarra:</div>
    <div id="datosElementos" class="datos-elementos" style="display:none;">
      <h3>Elementuen Masak</h3>
      <div class="elementos-grid" id="elementosGrid"></div>
    </div>
    <div id="details" class="details"></div>
  </div>

  <!-- === BALANCEADOR === -->
  <div class="panel">
    <h2>Ekuazio Doiketa</h2>
    <label for="ecuacion">Ekuazio Kimikoa</label>
    <input id="ecuacion" type="text" placeholder="Adib: N2 + H2 = NH3"/>
    <button class="btn-oreka" onclick="balancear()">Doitu</button>
    <div id="resBal" class="result">Ekuazioa doituta:</div>
  </div>
</div>

<script>
/* =========================================================
   1) MASA MOLAR (código anterior)
   ========================================================= */
const atomicMass = {
  H:1.008, He:4.0026, Li:6.94, Be:9.0122, B:10.81, C:12.011, N:14.007, O:15.999,
  F:18.998, Ne:20.180, Na:22.990, Mg:24.305, Al:26.982, Si:28.085, P:30.974, S:32.06,
  Cl:35.45, Ar:39.948, K:39.098, Ca:40.078, Sc:44.956, Ti:47.867, V:50.942, Cr:51.996,
  Mn:54.938, Fe:55.845, Co:58.933, Ni:58.693, Cu:63.546, Zn:65.38, Ga:69.723, Ge:72.630,
  As:74.922, Se:78.971, Br:79.904, Kr:83.798, Rb:85.468, Sr:87.62, Y:88.906, Zr:91.224,
  Nb:92.906, Mo:95.95, Tc:98, Ru:101.07, Rh:102.91, Pd:106.42, Ag:107.87, Cd:112.41,
  In:114.82, Sn:118.71, Sb:121.76, Te:127.60, I:126.90, Xe:131.29, Cs:132.91, Ba:137.33,
  La:138.91, Ce:140.12, Pr:140.91, Nd:144.24, Pm:145, Sm:150.36, Eu:151.96, Gd:157.25,
  Tb:158.93, Dy:162.50, Ho:164.93, Er:167.26, Tm:168.93, Yb:173.05, Lu:174.97, Hf:178.49,
  Ta:180.95, W:183.84, Re:186.21, Os:190.23, Ir:192.22, Pt:195.08, Au:196.97, Hg:200.59,
  Tl:204.38, Pb:207.2, Bi:208.98, Po:209, At:210, Rn:222, Fr:223, Ra:226, Ac:227, Th:232.04,
  Pa:231.04, U:238.03, Np:237, Pu:244, Am:243, Cm:247, Bk:247, Cf:251, Es:252, Fm:257,
  Md:258, No:259, Lr:266, Rf:267, Db:268, Sg:271, Bh:270, Hs:269, Mt:278, Ds:281, Rg:282,
  Cn:285, Nh:286, Fl:289, Mc:289, Lv:293, Ts:294, Og:294
};

function parse(formula) {
  const stack = [new Map()];
  let current = stack[0];
  const regex = /(\(|\)|\[|\]|\{|\}|[A-Z][a-z]*|\d+)/g;
  let match, lastToken = '';
  while ((match = regex.exec(formula)) !== null) {
    const token = match[0];
    if (token >= '0' && token <= '9') {
      const times = parseInt(token, 10);
      if (lastToken && /^[A-Z][a-z]*$/.test(lastToken)) {
        current.set(lastToken, (current.get(lastToken) || 0) + times - 1);
      }
    } else if (token === '(' || token === '[' || token === '{') {
      const nuevo = new Map();
      stack.push(nuevo);
      current = nuevo;
    } else if (token === ')' || token === ']' || token === '}') {
      const cerrado = stack.pop();
      current = stack[stack.length - 1];
      let sub = formula.slice(regex.lastIndex).match(/^\d+/);
      sub = sub ? parseInt(sub[0], 10) : 1;
      for (const [k, v] of cerrado) {
        current.set(k, (current.get(k) || 0) + v * sub);
      }
      if (sub > 1) regex.lastIndex += String(sub).length;
    } else {
      current.set(token, (current.get(token) || 0) + 1);
      lastToken = token;
    }
  }
  if (stack.length !== 1) throw new Error('Parentesiak desorekatuta');
  return current;
}

function calculate(formula) {
  const parsed = parse(formula);
  let total = 0;
  const breakdown = [];
  for (const [sym, qty] of parsed) {
    if (!atomicMass[sym]) throw new Error(`Sinbolo ezezaguna: ${sym}`);
    const mass = atomicMass[sym] * qty;
    total += mass;
    breakdown.push({sym, qty, mass});
  }
  return {total: total.toFixed(3), breakdown, elements: parsed};
}

const input = document.getElementById('formula');
const result = document.getElementById('result');
const details = document.getElementById('details');
const datosElementos = document.getElementById('datosElementos');
const elementosGrid = document.getElementById('elementosGrid');

function render() {
  const f = input.value.trim();
  if (!f) {
    result.textContent = 'Masa molarra:';
    result.classList.remove('error');
    datosElementos.style.display = 'none';
    details.innerHTML = '';
    return;
  }
  try {
    const {total, breakdown, elements} = calculate(f);
    result.textContent = `${total} g/mol`;
    result.classList.remove('error');
    
    // Mostrar datos de elementos
    mostrarDatosElementos(elements);
    
    // Mostrar cálculo paso a paso
    let html = '<ul>';
    for (const {sym, qty, mass} of breakdown) {
      html += `<li>${qty} × ${sym} = ${mass.toFixed(3)} u</li>`;
    }
    html += '</ul>';
    details.innerHTML = html;
    
  } catch (e) {
    result.textContent = e.message;
    result.classList.add('error');
    datosElementos.style.display = 'none';
    details.innerHTML = '';
  }
}

function mostrarDatosElementos(elements) {
  const elementosUnicos = Array.from(elements.keys());
  
  if (elementosUnicos.length === 0) {
    datosElementos.style.display = 'none';
    return;
  }
  
  let html = '';
  elementosUnicos.forEach(sym => {
    const masa = atomicMass[sym];
    html += `
      <div class="elemento-item">
        <span><strong>${sym}</strong></span>
        <span>${masa} g/mol</span>
      </div>
    `;
  });
  
  elementosGrid.innerHTML = html;
  datosElementos.style.display = 'block';
}

input.addEventListener('input', render);
render();

/* =========================================================
   2) BALANCEADOR MEJORADO - Método matricial simple
   ========================================================= */
function balancear() {
  const raw = document.getElementById('ecuacion').value.trim();
  const resBal = document.getElementById('resBal');
  if (!raw) {
    resBal.textContent = 'Ekuazioa idatzi...';
    resBal.classList.remove('error');
    return;
  }
  try {
    const balanced = balanceEquation(raw);
    resBal.innerHTML = balanced; // Usar innerHTML para permitir estilos
    resBal.classList.remove('error');
  } catch (e) {
    resBal.textContent = e.message;
    resBal.classList.add('error');
  }
}

function formatSubindices(formula) {
  // Convertir números que siguen a letras en subíndices
  return formula.replace(/([A-Za-z])(\d+)/g, '$1<span class="subindice">$2</span>');
}

function balanceEquation(eq) {
  const sides = eq.split('=').map(s => s.trim());
  if (sides.length !== 2) throw new Error('Ekuazioak "=" izan behar du');
  
  const leftSpecies = sides[0].split('+').map(s => s.trim());
  const rightSpecies = sides[1].split('+').map(s => s.trim());
  
  const allSpecies = [...leftSpecies, ...rightSpecies];
  const compositions = allSpecies.map(parse);
  
  // Obtener todos los elementos únicos
  const elements = new Set();
  compositions.forEach(comp => {
    for (const elem of comp.keys()) elements.add(elem);
  });
  const elementList = Array.from(elements);
  
  // Construir matriz de coeficientes
  const matrix = [];
  for (const element of elementList) {
    const row = [];
    for (let i = 0; i < allSpecies.length; i++) {
      const count = compositions[i].get(element) || 0;
      // Reactivos: positivo, Productos: negativo
      row.push(i < leftSpecies.length ? count : -count);
    }
    matrix.push(row);
  }
  
  // Resolver sistema (método simple para ecuaciones pequeñas)
  const coefficients = solveSimpleSystem(matrix);
  
  // Construir ecuación balanceada con coeficientes resaltados y subíndices
  const leftBalanced = leftSpecies.map((sp, i) => 
    formatCoefficient(coefficients[i], sp)
  ).join(' + ');
  
  const rightBalanced = rightSpecies.map((sp, i) => 
    formatCoefficient(coefficients[i + leftSpecies.length], sp)
  ).join(' + ');
  
  return leftBalanced + ' = ' + rightBalanced;
}

function formatCoefficient(coef, species) {
  const speciesWithSub = formatSubindices(species);
  if (coef === 1) {
    return speciesWithSub;
  } else {
    return `<span class="coeficiente">${coef}</span>${speciesWithSub}`;
  }
}

function solveSimpleSystem(matrix) {
  const numVars = matrix[0].length;
  let coeffs = Array(numVars).fill(1);
  
  // Método iterativo simple para ecuaciones químicas comunes
  let improved = true;
  for (let iter = 0; iter < 50 && improved; iter++) {
    improved = false;
    
    for (let i = 0; i < matrix.length; i++) {
      let sum = 0;
      for (let j = 0; j < numVars; j++) {
        sum += matrix[i][j] * coeffs[j];
      }
      
      if (Math.abs(sum) > 0.001) {
        improved = true;
        // Encontrar el coeficiente con mayor contribución al error
        let maxContrib = 0;
        let maxIndex = -1;
        for (let j = 0; j < numVars; j++) {
          const contrib = Math.abs(matrix[i][j] * coeffs[j]);
          if (contrib > maxContrib && matrix[i][j] !== 0) {
            maxContrib = contrib;
            maxIndex = j;
          }
        }
        
        if (maxIndex !== -1) {
          // Ajustar el coeficiente para balancear esta ecuación
          let adjustment = -sum / matrix[i][maxIndex];
          coeffs[maxIndex] += adjustment;
          
          // Mantener coeficientes positivos
          if (coeffs[maxIndex] < 0.1) coeffs[maxIndex] = 0.1;
        }
      }
    }
  }
  
  // Convertir a enteros mínimos
  return convertToMinimalIntegers(coeffs);
}

function convertToMinimalIntegers(coeffs) {
  // Encontrar el mínimo común múltiplo de los denominadores
  const floatCoeffs = coeffs.map(c => Math.abs(c));
  
  // Probar diferentes escalas para encontrar enteros
  for (let scale = 1; scale <= 12; scale++) {
    const scaled = floatCoeffs.map(c => Math.round(c * scale));
    const allIntegers = scaled.every((val, i) => 
      Math.abs(val - floatCoeffs[i] * scale) < 0.01
    );
    
    if (allIntegers) {
      // Simplificar dividiendo por MCD
      let gcd = scaled[0];
      for (let i = 1; i < scaled.length; i++) {
        gcd = computeGCD(gcd, scaled[i]);
      }
      return scaled.map(val => val / gcd);
    }
  }
  
  // Si no encontramos enteros perfectos, usar los valores redondeados
  return coeffs.map(c => Math.round(c));
}

function computeGCD(a, b) {
  a = Math.round(Math.abs(a));
  b = Math.round(Math.abs(b));
  while (b !== 0) {
    const temp = b;
    b = a % b;
    a = temp;
  }
  return a;
}
</script>
</body>

</html>
